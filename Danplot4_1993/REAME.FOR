      options (dreal,intl)
      options (undef,check)
C     REAME(ROTATIONAL EQUILIBRIUM ANALYSIS OF MULTILAYERED EMBANKMENTS)
C
C     ******************************************************************
C     THIS PROGRAM WAS DEVELOPED BY DR. Y. H. HUANG, PROFESSOR OF CIVIL
C     ENGINEERING, UNIVERSITY OF KENTUCKY, LEXINGTON, KY. 40506.
C     ******************************************************************
      CHARACTER*20 TITLE
      REAL LX,LY
      COMMON/A2/RR,FF,R,ROO
      COMMON/A1/C,DMIN,G,GW,NSLI,NSRCH,RL,RS,RU,SEIC,SLM,TANPHI,X0,Y0
      COMMON/A3/KR,KRA,NQ,NK
      COMMON/A4/NBL,NPBL,NPWT,NSPG,NWT,SLOPE,XBL,XWT,YBL,YINT,YWT
      COMMON/A6/BFS,IC,ISTP,LBSHP,METHOD,NSTP
      DIMENSION C(19),FS(5),FSM(5),G(19),LINO(9,11),NBP(9,11),
     * NEP(9,11),NCIR(10),NPBL(20),PHID(19),RDEC(10),RL(11),RRM(5),RU(5)
     * ,SLOPE(49,20),TANPHI(19),X(3),XBL(50,20),XMINFS(5),XMINR(5),
     * XMINX(5),XWT(50,5),Y(3),YBL(50,20),YINT(49,20),YMINY(5),YWT(50,5)
      DIMENSION FF(90,5),INFC(10),NPWT(5),NOL(11),RR(90,5)
      DIMENSION BFS(5),ISTP(5),KRA(5)

      zero=0.00001
      open(unit=20,file='inreame.dat')


      READ(20,*)TITLE
C     ******************************************************************
      WRITE(6,*)TITLE
      READ (20,*)NCASE
C     ******************************************************************
      WRITE(6,40)NCASE
   40 FORMAT(//,10X,30HNUMBER OF CASES TO BE ANALYZED,I5,//)
      DO 1580 NC=1,NCASE
      WRITE(6,50)NC
   50 FORMAT(//,10X,11HCASE NUMBER,I5,///)
      READ(20,*)NBL,(NPBL(I),I=1,NBL)
C     ******************************************************************
      WRITE(6,60)NBL,(NPBL(I),I=1,NBL)
   60 FORMAT (  5X,25HNUMBER OF BOUNDARY LINES=,I5,/,5X,39HNUMBER OF POI
     *NTS ON BOUNDARY LINES ARE:,8(5X,I5))
      DO 70 J=1,NBL
      NPBLJ=NPBL(J)
      READ(20,*)(XBL(I,J),YBL(I,J),I=1,NPBLJ)
C     ******************************************************************
   70 WRITE(6,90) J,(I,XBL(I,J),YBL(I,J),I=1,NPBLJ)
   90 FORMAT(/,5X,20HON BOUNDARY LINE NO.,I2,31H,POINT NO. AND COORDINAT
     *ES ARE:,/,5(I5,2F10.3))
C  DETERMINE SLOPE OF EACH LINE SEGMENT AND INTERCEPT AT Y AXIS.
      WRITE(6,100)
  100 FORMAT(/,5X,39HLINE NO. AND SLOPE OF EACH SEGMENT ARE:)
      DO 130 J=1,NBL
      NPBL1=NPBL(J)-1
      DO 120 I=1,NPBL1
      IF(abs(XBL(I+1,J)-XBL(I,J)).lt.zero)GO TO 110
      SLOPE(I,J)=(YBL(I+1,J)-YBL(I,J))/(XBL(I+1,J)-XBL(I,J))
      GO TO 120
  110 SLOPE(I,J)=99999.
  120 YINT(I,J)=YBL(I,J)-SLOPE(I,J)*XBL(I,J)
      WRITE(6,140)J,(SLOPE(I,J),I=1,NPBL1)
  130 CONTINUE
  140 FORMAT(7X,I5,(12F10.3))
      READ(20,*)NRCZ,NPLOT,NQ
C     ******************************************************************
      IF(NQ.EQ.0) NQ=1
      WRITE(6,150)NRCZ,NPLOT,NQ
  150 FORMAT(/,5X,28HNO. OF RADIUS CONTROL ZONES=,I3,5X,16HPLOT OR NO PL
     *OT=,I3,5X,21HNO. OF SEEPAGE CASES=,I3)
      NQQ=NQ
C  NGS IS INITIALIZED 0 BUT WILL CHANGE TO 1 WHEN SEARCH FOLLOWS GRID.
      NGS=0
      KRR=0
      IF(NRCZ.EQ.0)GO TO 250
      READ(20,*)(NOL(I),I=1,NRCZ)
C     ******************************************************************
      WRITE(6,160)(NOL(I),I=1,NRCZ)
  160 FORMAT(/,5X,57HTOTAL NO. OF LINES AT BOTTOM OF RADIUS CONTROL ZONE
     *S ARE:,10I5)
      READ(20,*) (RDEC(I),I=1,NRCZ)
C     ******************************************************************
      DO 170 I=1,NRCZ
      NOLI=NOL(I)
      READ (20,*) NCIR(I),INFC(I),(LINO(J,I),NBP(J,I),NEP(J,I)
     *,J=1,NOLI)
C     ******************************************************************
      WRITE(6,180)I,RDEC(I),NCIR(I),INFC(I)
      DO 170 J=1,NOLI
  170 WRITE(6,190)LINO(J,I),NBP(J,I),NEP(J,I)
  180 FORMAT(/,5X,23HFOR RAD. CONT. ZONE NO.,I3,5X,17HRADIUS DECREMENT=,
     *F10.3,5X,15HNO. OF CIRCLES=,I3,5X,24HID NO. FOR FIRST CIRCLE=,I3)
  190 FORMAT(8X,9HLINE NO.=,I3,5X,14HBEGIN PT. NO.=,I3,5X,12HEND PT. NO.
     *=,I3)
      NOL1=NOL(1)
      XLE=XBL(NBP(1,1),LINO(1,1))
      XRE=XBL(NEP(1,1),LINO(1,1))
      IF (NOL1.EQ.1) GO TO 210
      DO 200 I=2,NOL1
      IF(XBL(NBP(I,1),LINO(I,1)).LT.XLE)XLE=XBL(NBP(I,1),LINO(I,1))
      IF(XBL(NEP(I,1),LINO(I,1)).GT.XRE)XRE=XBL(NEP(I,1),LINO(I,1))
  200 CONTINUE
  210 IF(abs(XLE-XBL(1,NBL)).lt.zero .AND.
     *  abs(XRE-XBL(NPBL(NBL),NBL)).lt.zero) GO TO 230
      IF(NRCZ.NE.1)GO TO 230
      WRITE(6,220)
  220 FORMAT(/,5X,89HEND POINT OF LOWEST BOUNDARY LINE IS NOT EXTENDED T
     *O THE SAME X COORDINATE AS GROUND LINE,/,5X,52HOR GROUND LINE IS T
     *OO LONG AND INCLUDES ROCK SURFACE)
      STOP
C  KRB IS THE NO. ASSIGNED TO THE FIRST ADDITIONAL CIRCLE AFTER ALL THE
C  REGULAR NCIR(NCRZ) CIRCLES ARE NUMBERED.
  230 DO 240 I=1,NRCZ
  240 KRR=KRR+NCIR(I)
      KRB=KRR+1
  250 NOL(NRCZ+1)=1
C  USE EVERY SEGMENT OF GROUND LINE TO DETERMINE MINIMUM RADIUS
      LINO(1,NRCZ+1)=NBL
      NBP(1,NRCZ+1)=1
      NEP(1,NRCZ+1)=NPBL(NBL)
C  NSOIL IS NO. OF SOIL LAYERS, WHICH IS EQUAL TO NO. OF SOIL BOUNDARY-1
      NSOIL=NBL-1
      DO 260 I=1,NSOIL
      READ(20,*)C(I),PHID(I),G(I)
C     ******************************************************************
      IF(G(I).GT.900.)G(I)=G(I)*0.00981
  260 CONTINUE
      WRITE(6,270)
  270 FORMAT(/,5X,8HSOIL NO.,2X,8HCOHESION,5X,8HF. ANGLE,5X,8HUNIT WT.)
      IF(G(1).GT.900.)WRITE(6,280)
  280 FORMAT (/,5X,60HALL UNIT WEIGHTS HAVE BEEN CONVERTED FROM KG/CU M
     *TO KN/CU M)
      DO 290 I=1,NSOIL
  290 WRITE(6,300)I,C(I),PHID(I),G(I)
  300 FORMAT (5X,I5,3(3X,F10.3))
      DO 310 I=1,NSOIL
  310 TANPHI(I)=TAN(PHID(I)*3.141593/180.)
      READ(20,*)METHOD,NSPG,NSRCH,NSLI,NK
C     ******************************************************************
      READ(20,*)SEIC,DMIN,GW
C     ******************************************************************
      IF(GW.GT.900.)GW=GW*0.00981
      WRITE(6,320)SEIC,DMIN,GW
  320 FORMAT(/,5X,20HSEISMIC COEFFICIENT=,F10.3,5X,28HMIN. DEPTH OF TALL
     *EST SLICE=,F10.3,5X,21HUNIT WEIGHT OF WATER=,F10.3)
      IF (METHOD) 330,330,350
  330 WRITE(6,340)
  340 FORMAT(/,5X,57HTHE FACTORS OF SAFETY ARE DETERMINED BY THE NORMAL
     *METHOD)
      GO TO 370
  350 WRITE(6,360)
  360 FORMAT(/,5X,68HTHE FACTORS OF SAFETY ARE DETERMINED BY THE SIMPLIF
     *IED BISHOP METHOD)
  370 WRITE(6,380)NSPG,NSRCH,NSLI,NK
  380 FORMAT(/,5X,5HNSPG=,I2,2X,6HNSRCH=,I2,2X,14HNO. OF SLICES=,I3,
     * 2X,18HNO. OF ADD. RADII=,I2)
      IF(NRCZ.EQ.0.AND.NSRCH.NE.2) GO TO 1540
      XINC=0.
      YINC=0.
      IF (NSPG.EQ.2)GO TO 430
      IF (NSPG.EQ.0)GO TO 450
      READ(20,*)(NPWT(I),I=1,NQ)
C     ******************************************************************
      WRITE(6,390)(NPWT(I),I=1,NQ)
  390 FORMAT(/,5X,43HNO. OF POINTS ON WATER TABLE FOR EACH CASE=,5I4)
      DO 410 J=1,NQ
      NPWTJ=NPWT(J)
      READ(20,*)(XWT(I,J),YWT(I,J),I=1,NPWTJ)
C     ******************************************************************
      WRITE(6,420)J,(I,XWT(I,J),YWT(I,J),I=1,NPWTJ)
      IF(XWT(1,J).LE.XBL(1,NBL).AND.XWT(NPWT(J),J).GE.XBL(NPBL(NBL),
     *NBL)) GO TO 410
      WRITE(6,400)J
  400 FORMAT(/,5X,20HPIEZOMETRIC LINE NO.,I2,89H IS NOT EXTENDED AS FAR
     *OUT AS GROUND LINE. PLEASE CHANGE DATA AND RUN THE PROGRAM AGAIN.
     *)
      GO TO 1580
  410 CONTINUE
  420 FORMAT(/,5X,23HUNDER SEEPAGE CONDITION,I2,46H,POINT NO. AND COORDI
     *NATES OF WATER TABLE ARE:,/,5(I5,2F10.3))
      GO TO 450
  430 READ(20,*) (RU(I),I=1,NQ)
C     ******************************************************************
      WRITE(6,440) (RU(I),I=1,NQ)
  440 FORMAT(/,5X,20HPORE PRESSURE RATIO=,5F10.3)
  450 IF(NSRCH.NE.0)GO TO 530
C  USE GRID FOR DETERMINING FACTORS OF SAFETY AT VARIOUS POINTS
      READ(20,*)(X(I),Y(I),I=1,3),XINC,YINC
C     ******************************************************************
      READ(20,*) NJ,NI
C     ******************************************************************
      WRITE(6,460)(X(I),Y(I),I=1,3),NJ,NI
  460 FORMAT(/,9H POINT1=(,F10.3,1H,,F10.3,1H),9H POINT2=(,F10.3,1H,,F10
     *.3,1H),9H POINT3=(,F10.3,1H,,F10.3,1H),4H NJ=,I5,4H NI=,I5)
      IF(abs(XINC).gt.zero.OR.abs(YINC).gt.zero) WRITE(6,470)XINC,YINC
  470 FORMAT(5X,50HAUTOMATIC SEARCH WILL FOLLOW AFTER GRID WITH XINC=,
     * F10.3,10H AND YINC=,F10.3)
      DO 480 I=1,NQ
      ISTP(I)=0
  480 XMINR(I)=1.0E06
      ROO=0.
      NP=0
      IF(NI.NE.0) GO TO 490
      LX=0.
      LY=0.
      GO TO 500
  490 LX=(X(3)-X(2))/NI
      LY=(Y(3)-Y(2))/NI
  500 IF(NJ.NE.0)GO TO 510
      DX=0.
      DY=0.
      GO TO 520
  510 DX=(X(2)-X(1))/NJ
      DY=(Y(2)-Y(1))/NJ
  520 XV=X(1)
      YV=Y(1)
      XH=X(1)
      YH=Y(1)
      GO TO 650
C  DO NOT USE GRID
  530 READ(20,*) NP
C     ******************************************************************
      WRITE(6,540) NP
  540 FORMAT(/,5X,30HNO. OF CENTRES TO BE ANALYZED=,I5)
  550 IF(NSRCH.NE.1) GO TO 560
      NQ=1
      ISTP(1)=0
      XMINR(1)=1.0E06
      GO TO 580
  560 READ(20,*)XV,YV,R
C     ******************************************************************
      IF(NRCZ.EQ.0.AND.abs(R).lt.zero) GO TO 1520
      DO 570 I=1,NQ
      ISTP(I)=0
  570 XMINR(I)=1.0E06
      GO TO 630
  580 IF(NGS.EQ.1) GO TO 600
      READ(20,*)XV,YV,XINC,YINC
C     ******************************************************************
      WRITE(6,590)XV,YV,XINC,YINC
  590 FORMAT(/T2,'POINT=(',F8.3,',',F8.3,')',' XINC=',F8.3,' YINC=',F8.3
     * )

      GO TO 620
  600 LM=NQQ-NP+1
      IF (ISTP(LM).EQ.0) GO TO 610
      LM=LM+1
      NP=NP-1
  610 XV=XMINX(LM)
      YV=YMINY(LM)

  620 R=0.
  630 XOO=XV
      YOO=YV
      ROO=R
      NP=NP-1
      SLM=0.
      NI=0
      NJ=0
      IF(NSRCH.GT.1)then 
        DX=0
        DY=0
      else
        DX=XINC
        DY=YINC
        NCT=0
        NFD=0
        NSW=0
        NHV=0
        MOM=2
C       (NAGAIN IS ASSIGNED 1 WHEN THE FULL INCREMENT OF SEARCH IS 
C       COMPLETED AND THE QUARTER SEARCH INCREMENT BEGINS)
        NAGAIN=0
C       (CHOOSE THE STARTING POINT FROM THE GRID WHICH IS DETERMINED BY
C       THE GIVEN THREE POINTS,(X(1),Y(1)),(X(2),Y(2)),(X(3),Y(3)) )
      end if
  650 NSTP=0
      IF(NGS.NE.0) then
        ISTP(LM)=0
        XMINR(LM)=1.0E06
      end if
      NI=NI+1
      NJ=NJ+1
      LBSHP=0
C     NSTATE IS ASSIGNED 2 WHEN A PREVIOUS SEARCH IS COMPLETED AND A SEARCH
C     FROM A NES INITIAL TRIAL CENTER BEGINS.
      NSTATE=0
      M=0
C     BEGIN CENTER LOOP
      DO 1500 II=1,NI
      DO 1490 JJ=1,NJ
      IF(NGS.EQ.0)LM=0
      IF(NSPG.EQ.0)LM=1
      IF(NSRCH.EQ.1 .AND. NSTATE.EQ.0.AND.NGS.EQ.0)LM=1
C     KR IS THE COUNTER FOR NO. OF NCIR CIRCLES BEING COMPUTED.
  670 KR=0
C     KRA IS THE COUNTER FOR NO. OF ADDITONAL RADII BEING COMPUTED.
      IF(NGS.EQ.1) GO TO 690
      DO 680 I=1,NQ
  680 KRA(I)=KRR
  690 IF(NSRCH.EQ.1.AND.NSTATE.EQ.2)GO TO 700
      GO TO 710
C     RETURN TO FULL INCREMENT FOR SEARCH AFTER COMPLETING ONE QUARTER
C     INCREMENT FOR PREVIOUS SEARCH POINT.
  700 IF(NGS.EQ.0)LM=LM+1
      M=0
      NCT=0
      NFD=0
      NSW=0
      NHV=0
      MOM=2
      NAGAIN=0
      XV=XOO
      YV=YOO
      DX=XINC
      DY=YINC
C     LB IS A PARAMETER INDICATING THE CASE NO. FOR SEEPAGE CONDITIONS;
C     ASSIGN 1 FOR ONE SEEPAGE CONDITION AND 0 FOR SEVERAL SEEPAGE
C     CONDITIONS TO BE COMPUTED AT THE SAME TIME.
  710 LB=LM
      IF(NGS.EQ.1)KRA(LB)=KRR
      X0=XV
      Y0=YV
      R=ROO
      IF(NSRCH.NE.1)GO TO 730
C     CHECK DISTANCE FROM CENTER TO INITIAL TRIAL CENTER
      IF(ABS(X0-XOO).LT.20.*XINC .OR. ABS(Y0-YOO).LT.20.*YINC)
     * GO TO 730
      WRITE(6,720)
  720 FORMAT(/,5X,'THE INCREMENTS USED FOR SEARCH ARE TOO SMALL,OR EQ
     *UAL TO 0, SO THE MINIMUM FACTOR OF SAFETY CANNOT BE FOUND')
      GO TO 1560
C     RLL IS DISTANCE FROM CENTER TO THE NEAREST END POINT OF GROUND LINE.
  730 RLL=SQRT((X0-XBL(1,NBL))**2+(Y0-YBL(1,NBL))**2)
      RLR=SQRT((X0-XBL(NPBL(NBL),NBL))**2+(Y0-YBL(NPBL(NBL),NBL))**2)
      IF (RLR.LT.RLL)RLL=RLR
      GO TO 830
C     DETERMINE FACTOR OF SAFETY WHEN RADIUS IS SPECIFIED.
  740 IF(R.GT.RS) GO TO 760
      WRITE(6,750)X0,Y0,R,RS
  750 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),16H WITH RADIUS OF ,
     * F8.3,/,45H RADIUS IS SMALLER THAN THE MINIMUM RADIUS OF, F10.3,
     * 43H SO THE CIRCLE DOES NOT INTERSECT THE SLOPE)
      GO TO 1560
  760 IF (NRCZ.EQ.0) GO TO 780
      IF (R.LE.RL(1)) GO TO 800
      WRITE(6,770)X0,Y0,R,RL(1)
  770 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),16H WITH RADIUS OF ,
     * F10.3,/,69H THE CIRCLE WILL CUT INTO LOWEST BOUNDARY,SO THE RADIU
     *S IS REDUCED TO,F10.3)
      R=RL(1)
      GO TO 800
  780 IF (R.LE.RLL) GO TO 800
      WRITE(6,790)X0,Y0,R,RLL
  790 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),16H WITH RADIUS OF ,
     * F8.3,/,41H THE RADIUS IS GREATER THAN THE RADIUS OF, F10.3,
     * 46H AS DETERMINED BY THE END POINT OF GROUND LINE)
      GO TO 1560
  800 SLM=0.
      WRITE(6,*)'VALUE OF R====',R
      CALL FSAFTY(FS,LB,XANBL,XBNBL,R)
      IF(NSTP.EQ.1) GO TO 1560
      DO 810 I=1,NQ
  810 WRITE(6,820)X0,Y0,R,FS(I),I
  820 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),16H WITH RADIUS OF ,
     * F10.3,21H FACTOR OF SAFETY IS ,F10.3,15H UNDER SEEPAGE ,I5)
      GO TO 1560
C     DETERMINE MAXIMUM RADIUS IN EACH CONTROL ZONE.
  830 NRCZ1=NRCZ+1
      DO 900 I=1,NRCZ1
      PRL=99999.
      NOLI=NOL(I)
      DO 880 J=1,NOLI
      NBPJI=NBP(J,I)
      NEPJI=NEP(J,I)-1
      DO 880 K=NBPJI,NEPJI
      IF(abs(XBL(K,LINO(J,I))-XBL(K+1,LINO(J,I))).lt.zero) GO TO 870
      XI=(X0+SLOPE(K,LINO(J,I))*(Y0-YINT(K,LINO(J,I))))/(SLOPE(K,
     * LINO(J,I))**2+1.)
      IF (XI.LT.XBL(K,LINO(J,I))) goto 840
      goto 850
  840 RLI=SQRT((X0-XBL(K,LINO(J,I)))**2+(Y0-YBL(K,LINO(J,I)))**2)
      GO TO 880
  850 IF(XI.GT.XBL(K+1,LINO(J,I))) GO TO 860
      RLI=SQRT((X0-XI)**2+(Y0-SLOPE(K,LINO(J,I))*XI-YINT(K,LINO(J,I)))
     * **2)
      GO TO 880
  860 RLI=SQRT((X0-XBL(K+1,LINO(J,I)))**2+(Y0-YBL(K+1,LINO(J,I)))**2)
      GO TO 880
  870 IF (Y0.LT. YBL(K,LINO(J,I))) GO TO 840
      IF(Y0.GT. YBL(K+1,LINO(J,I))) GO TO 860
      RLI=ABS(X0-XBL(K,LINO(J,I)))

  880 IF(RLI.LT.PRL)PRL=RLI
      IF(PRL.LE.RLL) GO TO 900
      WRITE(6,890) I
  890 FORMAT(/,58H ****WARNING AT NEXT CENTER**** AT RADIUS CONTROL ZONE
     * NO.,I2,58H,MAXIMUM RADIUS IS LIMITED BY THE END POINT OF GROUND L
     *INE)
      PRL=RLL
  900 RL(I)=PRL
      RS=RL(NRCZ1)
      IF(abs(R).gt.zero) GO TO 740
C     COMPUTE FACTOR OF SAFETY FOR EACH RADIUS AND COMPARE WITH PREVIOUS
C     FACTOR OF SAFETY
      DO 1050 I=1,NRCZ
      IF(NCIR(I).EQ.0) GO TO 1050
      R=RL(I)
      IF(RDEC(I)) 920,910,920
  910 DR=(RL(I)-RL(I+1))/NCIR(I)
      GO TO 930
  920 DR=RDEC(I)
  930 NCIRI=NCIR(I)
      R=R-(INFC(I)-1)*DR
      DO 1040 J=1,NCIRI
      SLM=0.
      IF(R.GE.RS) GO TO 960
      IF(KR.NE.0) GOTO 1130
C     IF CIRCLE DOES NOT INTERCEPT EMBANKMENT, ASSIGN A LARGE F.S.
      IF(LB.NE.0)GO TO 950
      DO 940 K=1,NQ
  940 FSM(K)=1.0E06
      GO TO 1130
  950 FSM(LB)=1.0E06
      GO TO 1130
  960 IF(R.LT.RL(I+1)) GO TO 1050
      CALL FSAFTY(FS,LB,XANBL,XBNBL,R)
      IF(NSTP.EQ.1) GO TO 1560
      IF(SLM.GE.DMIN) GO TO 990
      IF (KR.NE.0) GO TO 1060
      IF (LB.NE.0) GO TO 980
      DO 970 K=1,NQ
  970 FSM(K)=1.0E06
      RRM(K)=R
      GO TO 1060
  980 FSM(LB)=1.0E06
      RRM(LB)=R
      GO TO 1060
  990 CALL SAVE(FS,RRM,FSM,LB,XANBL,XBNBL,XASM,XBSM)
      IF(NGS-1) 1010,1000,1010
 1000 IF(FS(LB).LT.100.)GO TO 1030
      GO TO 1130
 1010 DO 1020 K=1,NQ
      IF(FS(K).LT.100.) GO TO 1030
 1020 CONTINUE
      GO TO 1130
 1030 IF(DR.LE.0.) GO TO 1050
 1040 R=R-DR
 1050 CONTINUE
      R=R+DR
C     ADD NK MORE CIRCLES IF THE FACTOR OF SAFETY FOR THE SMALLEST CIRCLE
C     IS SMALLER THAN THAT OF THE PRECEDING CIRCLE.
 1060 IF(KR.EQ.0) GO TO  1130
      SLM2=SLM
      R2=R
      DO 1120 IQ=1,NQ
      I=IQ
      IF(LB.GT.1)I=LB
      IF(KR.EQ.0.OR.KR.EQ.1.AND.SLM2.GT.DMIN) GO TO 1120
      IF(KR.EQ.1) GO TO 1070
      IF(FF(KR,I).GE.FF(KR-1,I)) GO TO 1120
 1070 RI=RR(KR,I)
      IF(SLM2-DMIN) 1090,1120,1080
 1080 DELTA2=(RI-RS)/(NK+1)
      GO TO 1100
 1090 DELTA2=(RI-R2)/(NK+1)
 1100 DO 1110 N=1,NK
      RI=RI+DELTA2
      R=RI
      SLM=0.
      CALL FSAFTY(FS,LB,XANBL,XBNBL,R)
      IF(SLM.LT.DMIN) GO TO 1120
      KRA(I)=KRA(I)+1
      RR(KRA(I),I)=R
      FF(KRA(I),I)=FS(I)
      IF(FS(I).GE.FSM(I)) GO TO 1110
      FSM(I)=FS(I)
      RRM(I)=R
      XASM=XANBL
      XBSM=XBNBL
 1110 CONTINUE
 1120 CONTINUE
 1130 M=M+1
      IF(NSRCH.NE.1) GO TO 1140
      IF(NSTATE-1) 1160,1160,1150
 1140 IF(NSPG.GE.1.AND.NGS.EQ.0) LM=LM+1
 1150 NSTATE=1
C     WRITE OUT FACTORS OF SAFETY FOR ALL CIRCLES AND THE LOWEST F.S.
 1160 IF(KR.NE.0) GO TO 1200
      IF(abs(SLM).lt.zero) GO TO 1180
      WRITE(6,1170)X0,Y0,LM
 1170 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),14H UNDER SEEPAGE,I5,
     * 45H THE DEPTH OF TALLEST SLICE IS LESS THAN DMIN)
      GO TO 1250
 1180 WRITE(6,1190) X0,Y0,LM
 1190 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),14H UNDER SEEPAGE,I5,
     * 40H THE CIRCLE DOES NOT INTERCEPT THE SLOPE)
      GO TO 1250
 1200 IF(ISTP(LM).EQ.1) GO TO 1270
      WRITE(6,1210)X0,Y0,LM
 1210 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),15H UNDER SEEPAGE ,I5,
     * 55H, THE RADIUS AND THE CORRESPONDING FACTOR OF SAFETY ARE:)
      WRITE(6,1220) (RR(KK,LM),FF(KK,LM),KK=1,KR)
      IF(KRA(LM).LT.KRB) GO TO 1230
      KRE=KRA(LM)
      WRITE(6,1220) (RR(KK,LM),FF(KK,LM),KK=KRB,KRE)
 1220 FORMAT(5(5X,2F10.3))
 1230 WRITE(6,1240) FSM(LM),RRM(LM)
 1240 FORMAT(5X,24HLOWEST FACTOR OF SAFETY=,F10.3,24H AND OCCURS AT RAD
     *IUS = ,F10.3,/)
C
C     DETERMINE THE MINIMUM FACTOR OF SAFETY FOR ALL POINTS ON GRID.
C
 1250 IF(NSRCH.EQ.1) GO TO 1280
      IF(M.EQ.1) GO TO 1260
      IF(FSM(LM).GE.XMINFS(LM)) GO TO 1270
 1260 XMINFS(LM)=FSM(LM)
      XMINR(LM)=RRM(LM)
      XMINX(LM)=X0
      YMINY(LM)=Y0
 1270 IF(LM.LT.NQ) GO TO 1140
      IF(NSRCH.EQ.2) GO TO 1560
      XV=XV+DX
      YV=YV+DY
      GO TO 1490
C     AUTOMATIC SEARCH
 1280 IF(M.EQ.1) GO TO 1300
      NCT=NCT+1
      IF(FSM(LM)-XMINFS(LM)) 1300,1290,1290
 1290 IF(NHV.EQ.1) GO TO 1310
      IF(NSW.NE.0) GO TO 1390
      IF(NCT.NE.1) GO TO 1380
C     REVERSE X-DIRECTION
      NCT=0
      XV=XV-MOM*DX
      NSW=1
      GO TO 1400
C
C     SAVE MIN. FS
 1300 XMINFS(LM)=FSM(LM)
      XMINR(LM)=RRM(LM)
      XMINX(LM)=X0
      YMINY(LM)=Y0
      XAMIN=XASM
      XBMIN=XBSM
      GO TO 1340
 1310 IF(NSW.NE.0) GO TO 1320
      IF(NCT.NE.1) GO TO 1330
C     REVERSE Y-DIRECTION
      NSW=1
      YV=YV-MOM*DY
      NCT=0
      GO TO 1400
 1320 IF(NCT.NE.1) GO TO 1330
      IF(NFD.NE.1) GO TO 1330
      NFD=2
      GO TO 1400
C     HORIZONTAL DIRECTION
 1330 NCT=0
      NFD=1
      M=1
      NSW=0
      NHV=0
      MOM=2
      XV=XMINX(LM)+DX
      YV=YMINY(LM)
      IF (abs(DX).lt.zero) NFD=2
      GO TO 1400
 1340 IF(NHV.EQ.1) GO TO 1360
      IF(NSW.EQ.0) GO TO 1350
      XV=XV-DX
      GO TO 1400
 1350 XV=XV+DX
      IF(abs(DX).lt.zero) GO TO 1380
      GO TO 1400
 1360 IF(NSW.EQ.0) GO TO 1370
      YV=YV-DY
      GO TO 1400
 1370 YV=YV+DY
      GO TO 1400
C     VERTICAL DIRECTION
 1380 M=1
      NFD=1
      NCT=0
      NHV=1
      MOM=2
      NSW=0
      XV=XMINX(LM)
      YV=YMINY(LM)+DY
      IF(abs(DY).lt.zero) NFD=2
      GO TO 1400
 1390 IF(NCT.NE.1) GO TO 1380
      IF(NFD.NE.1) GO TO 1380
      NFD=2
 1400 R=0
      IF(NFD.NE.2) GO TO 670
      NAGAIN=NAGAIN+1
      IF(NAGAIN.NE.1) GO TO 1430
C
C     DO THE SEARCH AGAIN BY USING ONE FOURTH OF THE INCREMENT IN X AND Y
C     DIRECTIONS
C
      IF(XMINFS(LM).LT.100.) GO TO 1420
      WRITE(6,1410)
 1410 FORMAT(/,5X,34HIMPROPER CENTER IS USED FOR SEARCH)
      NSTATE=2
      GO TO 1560
 1420 DX=XINC/4.
      DY=YINC/4.
      NFD=0
      NCT=0
      NSW=0
      NHV=0
      MOM=2
      M=1
      NAGAIN=NAGAIN+1
      XV=XMINX(LM)+DX
      YV=YMINY(LM)
      GO TO 670
 1430 IF(NSPG.EQ.1) WRITE(6,1440)LM
 1440 FORMAT(///,25H FOR PIEZOMETRIC LINE NO.,I5)
      IF(NSPG.EQ.2)WRITE(6,1450) RU(LM)
 1450 FORMAT(//,24H FOR PORE PRESSURE RATIO,F10.3)
      WRITE(6,1460)XMINX(LM),YMINY(LM),XMINR(LM),XMINFS(LM)
 1460 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),7H,RADIUS,F10.3,/,
     * 5X,31HTHE MINIMUM FACTOR OF SAFETY IS ,F10.3,//)
      IF(METHOD.EQ.1) GO TO 1480
      LBSHP=1
      X0=XMINX(LM)
      Y0=YMINY(LM)
      R=XMINR(LM)
      CALL FSAFTY(FS,LM,XAMIN,XBMIN,R)
      WRITE(6,1470) BFS(LM),IC
 1470 FORMAT(4X,'THE CORRESPONDING FACTOR OF SAFETY BY THE SIMPLIFIED',
     *' BISHOP METHOD=',F10.3,5X,'THE NUMBER OF ITERATIONS=',I5)
 1480 CONTINUE
C     IF(NPLOT.EQ.1) CALL XYPLOT(XMINFS(LM),XAMIN,XBMIN)
      IF(NSRCH.EQ.1) GO TO 1560
      NSTATE=2
      IF(NP.NE.0) GO TO 550
 1490 CONTINUE
      XH=XH+LX
      YH=YH+LY
      XV=XH
      YV=YH
 1500 CONTINUE
C     END CENTER LOOP
      DO 1510 LM=1,NQ
      IF(ISTP(LM).EQ.1) GO TO 1510
      IF(NSPG.EQ.1)WRITE(6,1440)LM
      IF(NSPG.EQ.2)WRITE(6,1450)RU(LM)
      WRITE(6,1460) XMINX(LM),YMINY(LM),XMINR(LM),XMINFS(LM)
 1510 CONTINUE
      GO TO 1560
 1520 WRITE(6,1530) XV,YV,R
 1530 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),7H,RADIUS,F10.3,/,
     * 5X,78HWHEN THE NUMBER OF RADIUS CONTROL ZONE IS 0,RADIUS SHOULD N
     *OT BE ASSIGNED ZERO)
      NP=NP-1
      GO TO 1560
 1540 WRITE(6,1550)
 1550 FORMAT(/,5X,102HRADIUS CONTROL ZONE IS NOT DEFINED SO THE PROGRAM
     *IS STOPPED. UNLESS NSRCH=2, NCRZ SHOULD NOT BE ZERO.)
      GO TO 1580
 1560 IF(NP.NE.0) GO TO 550
      IF(NSRCH.EQ.0.AND.(abs(XINC).gt.zero.OR.abs(YINC).gt.zero).AND.
     *   NSTP.EQ.0) GO TO 1570
      GO TO 1580
 1570 NSRCH=1
      NP=NQ
      NGS=1
      NQ=1
      GO TO 600
 1580 CONTINUE
      STOP
      END
C
C
      
      SUBROUTINE FSAFTY(FS,LM,XANBL,XBNBL,R)
C
C  THIS SUBROUTINE IS USED TO DETERMINE THE FACTOR OF SAFETY FOR EACH
C  TRIAL CIRCLE.  TO SAVE THE COMPUTER TIME, SEVERAL SEEPAGE CONDITIONS
C  ARE COMPUTED AT THE SAME TIME IF THE AUTOMATIC SEARCH IS NOT USED.
C  LM IS THE CASE NO. FOR SEEPAGE CONDITIONS; ASSIGN 0 FOR SEVERAL
C  SEEPAGE CONDITIONS TO BE COMPUTED AT THE SAME TIME
C
     
c      COMMON/A2/RR,FF,R,ROO
      COMMON/A1/C,DMIN,G,GW,NSLI,NSRCH,RL,RS,RU,SEIC,SLM,TANPHI,X0,Y0
      COMMON/A3/KR,KRA,NQ,NK
      COMMON/A4/NBL,NPBL,NPWT,NSPG,NWT,SLOPE,XBL,XWT,YBL,YINT,YWT
      COMMON/A6/BFS,IC,ISTP,LBSHP,METHOD,NSTP
      DIMENSION COSA(40),EFF(40,5),FS(5),LC(40),SINA(40),SLOPE(49,20),
     * W(40),WW(40),XC(40),XBL(50,20),YB(40,20),YBL(50,20),YC(40),
     * YINT(49,20),YT(40,5),NPBL(20),XWT(50,5),YWT(50,5),ISTP(5)
      DIMENSION BFS(5),KRA(5),XA(20),XAPT(40),XB(20),BB(40)
      DIMENSION C(19),G(19),NPWT(5),RL(11),RU(5),SL(40),TANPHI(19)
      zero=0.00001
      WRITE(6,*)'VALUE OF R =========',R
      GO TO 40
   10 IF(LM.NE.0) GO TO 30
      DO 20 L=1,NQ
   20 FS(L)=1.0E06
      GO TO 960
   30 FS(LM)=1.0E06
      GO TO 960
C  COMPUTE POINTS OF INTERSECTION BETWEEN CIRCLE AND BOUNDARY LINES.
   40 DO 100 J=1,NBL
        XA(J)=-99999.
        XB(J)=99999.
        NPBL1=NPBL(J)-1
        DO 90 I=1,NPBL1
          IF(SLOPE(I,J).LE.99999.) THEN
            A=1.+SLOPE(I,J)**2
            B=SLOPE(I,J)*(YINT(I,J)-Y0)-X0
            D=(YINT(I,J)-Y0)**2+X0**2-R**2
            TEST=B**2-A*D
            IF(ABS(TEST).LT.1.)GO TO 100
            IF(TEST.GT.0.) THEN
              XM=(-B-SQRT(TEST))/A
              XP=(-B+SQRT(TEST))/A
              IF(XM.GE.XBL(I,J)-0.01 .AND. XM.LE.XBL(I+1,J)+0.01) THEN
                XA(J)=XM
                IF(J.EQ.NBL)YA=SLOPE(I,NBL)*XA(NBL)+YINT(I,NBL)
              END IF
              IF(XP.GE.XBL(I,J)-0.01.AND.XP.LE.XBL(I+1,J)+0.01) THEN
                XB(J)=XP
                IF(J.EQ.NBL)YBB=SLOPE(I,NBL)*XB(NBL)+YINT(I,NBL)
              END IF
            END IF
          END IF
   90   CONTINUE
  100 CONTINUE

      IF(XA(NBL).lt.-99998..AND.XB(NBL).gt.99998.) GO TO 130
  110 WRITE(6,120) R
  120 FORMAT(/,46H ****WARNING AT NEXT CENTER**** WHEN RADIUS IS,F10.3,
     */,'CENTER OF CIRCLE LIES BELOW GROUND LINE OR CIRCLE DOES NOT INTE
     *RCEPT GROUND LINE PROPERLY, OR THE CIRCLE CUTS THE SLOPE',/,
     *'VERY SLIGHTLY, SO A LARGE FACTOR OF SAFETY IS ASSIGNED.')
      GO TO 10
C  REPLACE THE ARC AT THE END BY A VERTICAL LINE WHEN CENTER OF CIRCLE
C  LIES BELOW POINT A OR B.
  130 IF(Y0.GE.YA.OR.Y0.GE.YBB) GO TO 150
      WRITE(6,140)R
  140 FORMAT(/,' ****WARNING AT CENTER**** WHEN RADIUS IS',F10.3,
     * /,' THE CENTER OF CIRCLE IS LOCATED BELOW THE INTERSECTION OF CIR
     *CLE WITH GROUND LINE,SO A LARGE FACTOR OF SAFETY IS ASSIGNED')
      GO TO 10
  150 RMI=0.
      IF(Y0.GT.YA) GO TO 250
      XA(NBL)=X0-R
      XX=XA(NBL)
  160 DO 240 K=1,NBL
      KK=NBL+1-K
      NPBL1=NPBL(KK)-1
      YB(1,KK)=-9999.
      DO 170 I=1,NPBL1
      IF(abs(XBL(I,KK)-XBL(I+1,KK)).lt.zero) GO TO 170
      M=I
      IF(XX.GT.XBL(I,KK).AND.XX.LE.XBL(I+1,KK)) GO TO 180
  170 CONTINUE
      GO TO 190
  180 YB(1,KK)=SLOPE(M,KK)*XX+YINT(M,KK)
      IF(K.EQ.1) GO TO 230
  190 IF(YB(1,KK)+9999.) 200,240,200
  200 IF(Y0-YB(1,KK)) 210,210,220
  210 RMI=RMI+(YBJK-YB(1,KK))*C(KK)
      GO TO 230
  220 RMI=RMI+(YBJK-Y0)*C(KK)
      GO TO 260
  230 YBJK=YB(1,KK)
  240 CONTINUE
  250 IF(Y0.GT.YBB) GO TO 260
      XB(NBL)=X0+R
      XX=XB(NBL)
      GO TO 160
C  COMPUTE WIDTH OF SLICE,BB,AND SUBDIVIDE INTO SMALLER SLICES IF NEEDED
  260 NBLM=NBL-1
      NPBLM=NPBL(NBL)-1
      RB=(XB(NBL)-XA(NBL))/NSLI
      XANBL=XA(NBL)
      XBNBL=XB(NBL)
C  NSLICE IS THE ACTUAL NO. OF SLICES, WHICH IS GENERALLY GREATER THAN
C  NSLI.
      NSLICE=0
      XDIS=XA(NBL)
      DO 370 I=1,NSLI
      NAPT=0
      DO 270 J=2,NPBLM
      IF(XBL(J,NBL).LE.XDIS+0.01.OR.XBL(J,NBL).GE.XDIS+RB-0.01)
     * GO TO 270
      NAPT=NAPT+1
      XAPT(NAPT)=XBL(J,NBL)
  270 CONTINUE
      DO 290 J=2,NBLM
      IF(XA(J).LE.XDIS+0.01.OR.XA(J).GE. XDIS+RB-0.01) GO TO 280
      NAPT=NAPT+1
      XAPT(NAPT)=XA(J)
      GO TO 290
  280 IF(XB(J).LE.XDIS+0.01.OR.XB(J).GE.XDIS+RB-0.01) GO TO 290
      NAPT=NAPT+1
      XAPT(NAPT)=XB(J)
  290 CONTINUE
C  ARRANGE COORDINATES OF INTERMEDIATE POINTS BY INCREASING ORDE
      IF(NAPT-1) 350,340,300
  300 NAPT1=NAPT-1
      NKOT=0
      DO 320 L=1,NAPT1
      NKOT=NKOT+1
      XSM=XAPT(NKOT)
      NKOT1=NKOT+1
      KID=NKOT
      DO 310 K=NKOT1,NAPT
      IF(XAPT(K).GE.XSM) GO TO 310
      XSM=XAPT(K)
      KID=K
  310 CONTINUE
      XAPT(KID)=XAPT(NKOT)
      XAPT(NKOT)=XSM
  320 CONTINUE
      BB(NSLICE+1)=XAPT(1)-XDIS
      DO 330 L=2,NAPT
  330 BB(NSLICE+L)=XAPT(L)-XAPT(L-1)
      BB(NSLICE+NAPT+1)=XDIS+RB-XAPT(NAPT)
      GO TO 360
  340 BB(NSLICE+1)=XAPT(1)-XDIS
      BB(NSLICE+2)=XDIS+RB-XAPT(1)
      GO TO 360
  350 BB(NSLICE+1)=RB
  360 NSLICE=NSLICE+NAPT+1
      XDIS=XDIS+RB
  370 CONTINUE
      IJK=0
      DO 380 J=1,NSLICE
      IF(J.GT.NSLICE-IJK) GO TO 390
      IF(abs(BB(J)).lt.zero)IJK=IJK+1
  380 BB(J)=BB(J+IJK)
  390 NSLICE=NSLICE-IJK
      IF(NSLICE.LE.40) GO TO 410
      WRITE(6,400)NSLICE
  400 FORMAT(/,5X,'ACTUAL NO. OF SLICES IS',I3,',WHICH IS GREATER THAN T
     *HE DECLARED DIMENSION, SO THE COMPUTATION IS STOPPED')
      NSTP=1
      GO TO 960

C  COMPUTE X COORDINATES FOR CENTERLINE OF SLICE,XC
  410 XC(1)=XA(NBL)+BB(1)/2.
      DO 420 J=2,NSLICE
  420 XC(J)=XC(J-1)+(BB(J)+BB(J-1))/2.

C  COMPUTE INTERSECTION OF SLICE CENTERLINE WITH CIRCLE,YC, AND INCLINA-
C  TION OF FAILURE ARC AT BOTTOM OF SLICE.
      DO 430 J=1,NSLICE
      YC(J)=Y0+SQRT(R**2-(XC(J)-X0)**2)
      SINA(J)=(X0-XC(J))/R
      IF(YBB.GT.YA)SINA(J)=-SINA(J)
  430 COSA(J)=(Y0-YC(J))/R

C  COMPUTE INTERSECTION OF SLICE CENTERLINE WITH BOUNDARY LINE,YB.
      DO 490 J=1,NSLICE
      IDS=0
      DO 480 K=1,NBL
      YB(J,K)=-9999.
      NPBL1=NPBL(K)-1
      DO 440 I=1,NPBL1
      IF(abs(XBL(I,K)-XBL(I+1,K)).lt.zero) GO TO 440
      M=I
      IF(XC(J).GT.XBL(I,K).AND.XC(J).LE.XBL(I+1,K)) GO TO 450
  440 CONTINUE
      GO TO 480
  450 YB(J,K)=SLOPE(M,K)*XC(J)+YINT(M,K)
      IF(IDS.EQ.0) GO TO 470
      IF(K.EQ.1) GO TO 470
      IF(YB(J,K).GT.YBJK-0.1) GO TO 470
      WRITE(6,460)K
  460 FORMAT(/,5X,17HBOUNDARY LINE NO.,I3,71H IS OUT OF PLACE,PLEASE CHA
     *NGE THE INPUT DATA AND RUN THE PROGRAM AGAIN)
      NSTP=1
      GO TO 960
  470 YBJK=YB(J,K)
      IDS=1
  480 CONTINUE
      SL(J)=YB(J,NBL)-YC(J)
      IF(SL(J).GT.SLM)SLM=SL(J)
  490 CONTINUE
      IF(SLM.LT.0.1) GO TO 110
      IF(SLM.LT.DMIN) GO TO 960

C  COMPUTE WEIGHT OF SLICE,W,ACTUATING FORCE,WW,AND EARTHQUAKE FORCE.
      ID=0
      DO 670 J=1,NSLICE
      NINT=0
      W(J)=0.
      WW(J)=0.
      DO 670 K=1,NBL
      IF(YB(J,K)+9999.) 510,500,510
  500 ID=ID+1
      GO TO 670
  510 SL1=YB(J,NBL)-YB(J,K)
      IF(SL1.GE.SL(J)-0.01) GO TO 640
      IF(NINT.EQ.1) GO TO 530
      WRITE(6,520)X0,Y0,R
  520 FORMAT(/,1H0,'AT POINT (',F8.3,',',F8.3,')','WITH RADIUS OF ',
     * F8.3,/,1X,'THE CIRCLE CUTS INTO THE LOWEST BOUNDARY, SO THE COMPU
     *TATION IS STOPPED. PLEASE CHECK THE RADIUS CONTROL ZONE')
      NSTP=1
      GO TO 960
  530 IF(NFG) 630,540,630
  540 YBJ=YC(J)
      LC(J)=K-ID
      NFG=1
      IF(abs(C(LC(J))).lt.zero .AND. abs(TANPHI(LC(J))).lt.zero)GOTO 580
      IF(J .EQ.1) GO TO 650
      IF(abs(C(LC(J-1))).lt.zero .AND. abs(TANPHI(LC(J-1))).lt.zero)
     *  GOTO 550
      GO TO 650
  550 LCJ=LC(J-1)
      YBBJ=YB(J-1,NBL)
      IF(YBB-YA) 560,570,570
  560 ISIGN=1
      GO TO 620
  570 ISIGN=-1
      GO TO 620
  580 IF(J.EQ.1) GO TO 660
      IF(abs(C(LC(J-1))).gt.zero .OR. abs(TANPHI(LC(J-1))).gt.zero)
     *  GO TO 590
      GO TO 660
  590 LCJ=LC(J)
      YBBJ=YB(J,NBL)
      IF(YBB-YA) 600,610,610
  600 ISIGN=-1
      GO TO 620
  610 ISIGN=1
  620 YCW=Y0-SQRT(R**2-(XC(J)-BB(J)/2-X0)**2)
      WD=YBBJ-YCW
      WW(J)=ISIGN*0.5*WD**2*G(LCJ)*(Y0-YCW-WD/3.)/R
      IF(abs(C(LC(J-1))).lt.zero .AND. abs(TANPHI(LC(J-1))).lt.zero)
     *  GO TO 650
      GO TO 660
  630 YBJ=YB(J,K-ID)
      GO TO 650
  640 NFG=0
      NINT=1
      GO TO 660
  650 WG=BB(J)*(YB(J,K)-YBJ)*G(K-ID)
      W(J)=W(J)+WG
      WW(J)=WW(J)+WG*SINA(J)
      IF(abs(SEIC).lt.zero) GO TO 660
      IF(abs(C(K-ID)).lt.zero .AND. abs(TANPHI(K-ID)).lt.zero .AND. 
     * (YA.GE.YBB .AND. XC(J).GT.XBL(2,NBL) .OR. YA.LE.YBB .AND. 
     * XC(J).LT. XBL(2,NBL))) GO TO 660
      WW(J)=WW(J)+WG*SEIC*(Y0-0.5*(YB(J,K)+YBJ))/R
  660 ID=1
  670 CONTINUE
      L=0
      IF(NSPG.NE.0) GO TO 680
      L=1
      GO TO 830
  680 L=L+1
      IF(ISTP(L).EQ.1)GO TO 950
      IF(NSPG.EQ.2) GO TO 780
      IF (LM) 700,690,700
  690 LL=L
      GO TO 710
  700 LL=LM
      L=LM
  710 NPWT1=NPWT(LL)-1

C  COMPUTE INTERSECTION OF SLICE CENTERLINE WITH WATER TABLE,YT.
      DO 740 J=1,NSLICE
      DO 720 I=1,NPWT1
      M=I
      IF(XC(J).GE.XWT(I,LL) .AND. XC(J) .LE. XWT(I+1,LL)) GO TO 730
  720 CONTINUE
      GO TO 740
  730 YT(J,LL)=((YWT(M+1,LL)-YWT(M,LL))/(XWT(M+1,LL)-XWT(M,LL)))*(XC(J)-
     * XWT(M,LL))+YWT(M,LL)
  740 CONTINUE

C  COMPUTE EFFECTIVE WEIGHT OF SLICE,EFF.
      DO 770 J=1,NSLICE
      IF(YT(J,LL)-YC(J)) 760,760,750
  750 EFF(J,LL)=W(J)-(YT(J,LL)-YC(J))*GW*BB(J)
      GO TO 770
  760 EFF(J,LL)=W(J)
  770 CONTINUE
      GO TO 850
  780 IF(LM) 800,790,800
  790 LL=L
      GO TO 810
  800 LL=LM
      L=LM
  810 DO 820 J=1,NSLICE
  820 EFF(J,LL)=W(J)*(1.-RU(LL))
      GO TO 850
  830 DO 840 J=1,NSLICE
  840 EFF(J,L)=W(J)

C  COMPUTE RESISTING FORCE,RM,ACTUATING FORCE,OTM,AND FACTOR OF SAFETY
  850 RM=RMI
      OTM=0.
      DO 860 J=1,NSLICE
      RM=RM+C(LC(J))*BB(J)/COSA(J)+EFF(J,L)*COSA(J)*TANPHI(LC(J))
  860 OTM=OTM+WW(J)
      IF(OTM.GT.1. .AND. abs(RM).gt.zero) GO TO 880
      WRITE(6,870)R
  870 FORMAT(/,46H ****WARNING AT NEXT CENTER**** WHEN RADIUS IS,F10.3,
     * /,92H EITHER THE OVERTURNING OR THE RESISTING MOMENT IS 0,SO A LA
     *RGE FACTOR OF SAFETY IS ASSIGNED)
      FS(L)=1.0E06
      GO TO 940
  880 FS(L)=RM/OTM
      IF(FS(L).GT.0.) GO TO 890
      GO TO 920
  890 IF(METHOD.EQ.0 .AND. LBSHP .EQ. 0) GO TO 940
      IF(FS(L).GT. 100.) GO TO 940
      BFS(L)=FS(L)
      IF(FS(L).LT.1.) BFS(L)=2.
      IC=0
  900 IC=IC+1
      PFS=BFS(L)
      RA1=0.
      RA2=0.
      DO 910 J=1,NSLICE
      CJBJ=C(LC(J))*BB(J)+EFF(J,L)*TANPHI(LC(J))
      PFSC=PFS*COSA(J)+TANPHI(LC(J))*SINA(J)
      RA1=RA1+CJBJ/PFSC
  910 RA2=RA2+CJBJ*TANPHI(LC(J))*SINA(J)/PFSC**2
      BFS(L)=PFS*(1.+(RMI/PFS+RA1-OTM)/(OTM-RA2))
      IF(ABS((BFS(L)-PFS)/PFS).GT. 0.0001 .AND. IC.LT.10) GO TO 900
      FS(L)=BFS(L)
      IF(FS(L).GT.0.)GO TO 940
  920 WRITE(6,930)X0,Y0,R,L
  930 FORMAT(/,11H AT POINT (,F10.3,1H,,F10.3,1H),16H WITH RADIUS OF ,
     * F10.3, 15H UNDER SEEPAGE ,I2,/, 95H THE FACTOR OF SAFETY IS LESS
     *THAN OR EQUAL TO 0. CHECK PIEZOMETRIC LINE OR PORE PRESSURE RATIO)
      ISTP(L)=1
      IF(NQ.EQ.1) STOP
  940 IF(NSPG.EQ.0) GO TO 960
      IF(LM.NE.0)GO TO 960
  950 IF(L.LT.NQ) GO TO 680
  960 RETURN
      END
C
C
      SUBROUTINE SAVE(FS,RRM,FSM,LB,XANBL,XBNBL,XASM,XBSM)
C
C  THIS SUBROUTINE IS USED TO SAVE THE FACTOR OF SAFETY FOR VARIOUS
C  RADII AND DETERMINE WHICH ONE IS THE LOWEST.  IF A FACTOR OF SAFETY
C  SMALLER THAN THAT OF THE TWO ADJOINING RADII IS FOUND, ADDITIONAL
C  RADII WILL BE TRIED TO DETERMINE THE LOWEST FACTOR OF SAFETY
C
      COMMON/A2/RR,FF,R,ROO
      COMMON/A3/KR,KRA,NQ,NK
      DIMENSION FF(90,5),FS(5),FSM(5),KRA(5),RR(90,5),RRM(5)
      KR=KR+1
      DO 50 LP=1,NQ
      L=LP
      IF (LB.NE.0)L=LB
      RR(KR,L)=R
      FF(KR,L)=FS(L)
      IF (KR.NE.1) GO TO 10
      FSM(L)=FF(KR,L)
      RRM(L)=RR(KR,L)
      XASM=XANBL
      XBSM=XBNBL
   10 IF(FF(KR,L).GE.FSM(L)) GO TO 20
      FSM(L)=FF(KR,L)
      RRM(L)=RR(KR,L)
      XASM=XANBL
      XBSM=XBNBL
   20 IF(KR.LT.3 .OR. NK.EQ.0) GO TO 50
      IF(FF(KR,L).GT.FF(KR-1,L) .AND. FF(KR-1,L).LT.FF(KR-2,L)) GO TO 30
C
C  SUBDIVIDE THE MINIMUM RANGE
C
   30 DOT=R
      DO 40 I=1,2
      RI=RR(KR-3+I,L)
      DELTA=(RR(KR-2+I,L)-RR(KR-3+I,L))/(NK+1)
      DO 40 N=1,NK
      RI=RI+DELTA
      R=RI
      CALL FSAFTY(FS,LB,XANBL,XBNBL)
      KRA(L)=KRA(L)+1
      RR(KRA(L),L)=R
      FF(KRA(L),L)=FS(L)
      IF(FS(L).GE.FSM(L)) GO TO 40
      FSM(L)=FS(L)
      RRM(L)=R
      XASM=XANBL
      XBSM=XBNBL
   40 CONTINUE
      R=DOT
      IF(LB.NE.0) GO TO 60
   50 CONTINUE
   60 RETURN
      END
